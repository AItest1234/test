#!/usr/bin/env python3
"""
Test script to verify exploitation mode logic (confidence >70)
"""

def test_exploitation_trigger():
    """Test that exploitation mode is triggered at confidence >70"""
    
    # Mock confidence levels
    test_cases = [
        {"confidence": 65, "should_exploit": False},
        {"confidence": 70, "should_exploit": False},  # Must be > 70
        {"confidence": 71, "should_exploit": True},
        {"confidence": 75, "should_exploit": True},
        {"confidence": 85, "should_exploit": True},
    ]
    
    for case in test_cases:
        confidence = case["confidence"]
        exploitation_triggered = confidence > 70
        
        assert exploitation_triggered == case["should_exploit"], \
            f"Confidence {confidence}: expected exploit={case['should_exploit']}, got {exploitation_triggered}"
    
    print("✓ Exploitation triggers correctly at confidence >70")


def test_data_extraction_tracking():
    """Test that extracted data is properly tracked"""
    
    extracted_data = []
    
    # Simulate data extractions
    extractions = [
        {
            "payload": "'; SELECT @@version--",
            "data": "MySQL 5.7.33",
            "data_type": "database_version",
            "confidence": 95
        },
        {
            "payload": "'; SELECT current_user()--",
            "data": "root@localhost",
            "data_type": "user_data",
            "confidence": 95
        }
    ]
    
    for extraction in extractions:
        extracted_data.append(extraction)
    
    # Check tracking
    assert len(extracted_data) == 2, f"Expected 2 extractions, got {len(extracted_data)}"
    assert extracted_data[0]["data_type"] == "database_version"
    assert extracted_data[1]["data_type"] == "user_data"
    
    print("✓ Data extraction tracking works correctly")


def test_successful_exploitation_condition():
    """Test the condition for successful exploitation (2+ data points)"""
    
    # Case 1: No data extracted
    extracted_data = []
    successful = len(extracted_data) >= 2
    assert successful == False, "Should not be successful with 0 extractions"
    
    # Case 2: 1 data point
    extracted_data.append({"data": "MySQL 5.7"})
    successful = len(extracted_data) >= 2
    assert successful == False, "Should not be successful with 1 extraction"
    
    # Case 3: 2 data points
    extracted_data.append({"data": "root@localhost"})
    successful = len(extracted_data) >= 2
    assert successful == True, "Should be successful with 2 extractions"
    
    # Case 4: 3+ data points
    extracted_data.append({"data": "production_db"})
    successful = len(extracted_data) >= 2
    assert successful == True, "Should be successful with 3+ extractions"
    
    print("✓ Successful exploitation condition works correctly (2+ data points)")


def test_exploitation_mode_flow():
    """Test the complete exploitation mode flow"""
    
    exploitation_mode = False
    high_confidence_achieved = False
    extracted_data = []
    successful_exploitation = False
    
    # Step 1: Build confidence
    confidence = 65
    if confidence > 70:
        exploitation_mode = True
        high_confidence_achieved = True
    assert exploitation_mode == False, "Should not activate at confidence 65"
    
    # Step 2: Achieve high confidence
    confidence = 75
    if confidence > 70:
        exploitation_mode = True
        high_confidence_achieved = True
    assert exploitation_mode == True, "Should activate at confidence 75"
    assert high_confidence_achieved == True
    
    # Step 3: Extract data
    if exploitation_mode:
        # Simulate extraction
        extracted_data.append({"data": "MySQL 5.7", "data_type": "database_version"})
        extracted_data.append({"data": "root@localhost", "data_type": "user_data"})
        
        if len(extracted_data) >= 2:
            successful_exploitation = True
    
    assert len(extracted_data) == 2, "Should have 2 data points"
    assert successful_exploitation == True, "Should mark as successful"
    
    print("✓ Complete exploitation mode flow works correctly")


def test_data_type_classification():
    """Test that data types are correctly classified"""
    
    data_types = [
        "database_version",
        "os_version",
        "file_contents",
        "user_data",
        "admin_data",
        "metadata",
        "hostname",
        "command_output"
    ]
    
    # Simulate extractions with different types
    extractions = [
        {"data": "MySQL 5.7", "data_type": "database_version"},
        {"data": "Linux 4.15.0", "data_type": "os_version"},
        {"data": "root:x:0:0", "data_type": "file_contents"},
        {"data": "ami-abc123", "data_type": "metadata"}
    ]
    
    for extraction in extractions:
        assert extraction["data_type"] in data_types, \
            f"Unknown data type: {extraction['data_type']}"
    
    print("✓ Data type classification is valid")


def test_skip_poc_when_data_extracted():
    """Test that PoC generation is skipped when real data is extracted"""
    
    extracted_data = [
        {"data": "MySQL 5.7", "data_type": "database_version"},
        {"data": "root@localhost", "data_type": "user_data"}
    ]
    
    # Decision logic
    should_generate_poc = len(extracted_data) == 0
    
    assert should_generate_poc == False, \
        "Should not generate PoC when real data was extracted"
    
    # Test with no data
    extracted_data = []
    should_generate_poc = len(extracted_data) == 0
    
    assert should_generate_poc == True, \
        "Should generate PoC when no data was extracted"
    
    print("✓ PoC generation skip logic works correctly")


if __name__ == "__main__":
    print("Testing Exploitation Mode (Confidence >70)\n")
    print("=" * 60)
    
    test_exploitation_trigger()
    print()
    
    test_data_extraction_tracking()
    print()
    
    test_successful_exploitation_condition()
    print()
    
    test_exploitation_mode_flow()
    print()
    
    test_data_type_classification()
    print()
    
    test_skip_poc_when_data_extracted()
    print()
    
    print("=" * 60)
    print("\n✓✓✓ All exploitation mode tests passed!")
    print("\nKey Points:")
    print("  • Confidence >70 triggers exploitation mode")
    print("  • Continues until 2+ data points extracted")
    print("  • Tracks data types (DB version, OS info, files, etc.)")
    print("  • Skips PoC when real data extracted")
    print("  • Real exploitation, not just detection")
